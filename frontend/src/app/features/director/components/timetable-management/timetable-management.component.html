<div class="timetable-management">
  <!-- Floating Shapes Background -->
  <div class="floating-shapes" aria-hidden="true">
    <div class="shape shape-1"></div>
    <div class="shape shape-2"></div>
  </div>

  <!-- Header -->
  <div class="page-header">
    <div class="header-content">
      <h1>Gestion des Emplois du Temps</h1>
      <p class="subtitle">Création, validation et résolution des conflits</p>
      
      <div class="header-actions">
        <button mat-raised-button color="primary" (click)="createNewTimetable()" [disabled]="creating">
          <mat-icon *ngIf="!creating">add</mat-icon>
          <mat-icon *ngIf="creating">hourglass_top</mat-icon>
          {{ creating ? 'Création...' : 'Nouvel Emploi du Temps' }}
        </button>
        <button mat-button color="accent" (click)="exportTimetable()">
          <mat-icon>download</mat-icon>
          Exporter
        </button>
      </div>
    </div>
  </div>

  <!-- Loading -->
  <div *ngIf="loading" class="loading-container">
    <mat-spinner></mat-spinner>
  </div>

  <!-- Content Tabs -->
  <div *ngIf="!loading" class="content-container">
    <mat-tab-group class="custom-tabs" dynamicHeight>
      
      <!-- Vue Hebdomadaire -->
      <mat-tab label="Vue Hebdomadaire">
        <div class="tab-content">
          <mat-card class="weekly-view-card">
            <mat-card-header>
              <mat-icon mat-card-avatar>calendar_view_week</mat-icon>
              <mat-card-title>Emploi du Temps de la Semaine</mat-card-title>
            </mat-card-header>
            
            <mat-card-content>
              <div class="weekly-grid">
                <!-- En-têtes des jours -->
                <div class="grid-header">
                  <div class="time-header">Horaire</div>
                  <div *ngFor="let day of daysOfWeek" class="day-header">{{ day }}</div>
                </div>
                
                <!-- Lignes des créneaux horaires -->
                <div *ngFor="let row of weeklyView" class="grid-row">
                  <div class="time-slot">{{ row[0] }}</div>
                  <div *ngFor="let dayTimetables of row.slice(1); let dayIndex = index" 
                       class="day-cell">
                    <div *ngFor="let timetable of dayTimetables" 
                         class="timetable-item"
                         [class]="'status-' + timetable.status.toLowerCase()">
                      <div class="subject-name">{{ timetable.subjectId }}</div>
                      <div class="group-name">{{ timetable.groupId }}</div>
                      <div class="room-name">{{ timetable.roomId }}</div>
                      <mat-chip class="status-chip" [color]="getStatusColor(timetable.status)">
                        {{ timetable.status }}
                      </mat-chip>
                    </div>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Liste des Emplois du Temps -->
      <mat-tab label="Liste des Emplois du Temps">
        <div class="tab-content">
          <mat-card class="list-card">
            <mat-card-header>
              <mat-icon mat-card-avatar>list</mat-icon>
              <mat-card-title>Tous les Emplois du Temps</mat-card-title>
            </mat-card-header>
            
            <mat-card-content>
              <div class="table-container">
                <table mat-table [dataSource]="timetables" class="timetable-table">
                  
                  <ng-container matColumnDef="subject">
                    <th mat-header-cell *matHeaderCellDef>Matière</th>
                    <td mat-cell *matCellDef="let timetable">{{ timetable.subjectId }}</td>
                  </ng-container>

                  <ng-container matColumnDef="group">
                    <th mat-header-cell *matHeaderCellDef>Groupe</th>
                    <td mat-cell *matCellDef="let timetable">{{ timetable.groupId }}</td>
                  </ng-container>

                  <ng-container matColumnDef="teacher">
                    <th mat-header-cell *matHeaderCellDef>Enseignant</th>
                    <td mat-cell *matCellDef="let timetable">{{ timetable.teacherId }}</td>
                  </ng-container>

                  <ng-container matColumnDef="time">
                    <th mat-header-cell *matHeaderCellDef>Horaire</th>
                    <td mat-cell *matCellDef="let timetable">
                      {{ daysOfWeek[timetable.dayOfWeek] }} {{ timetable.startTime }}-{{ timetable.endTime }}
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="room">
                    <th mat-header-cell *matHeaderCellDef>Salle</th>
                    <td mat-cell *matCellDef="let timetable">{{ timetable.roomId }}</td>
                  </ng-container>

                  <ng-container matColumnDef="status">
                    <th mat-header-cell *matHeaderCellDef>Statut</th>
                    <td mat-cell *matCellDef="let timetable">
                      <mat-chip [color]="getStatusColor(timetable.status)">
                        {{ timetable.status }}
                      </mat-chip>
                    </td>
                  </ng-container>

                  <ng-container matColumnDef="actions">
                    <th mat-header-cell *matHeaderCellDef>Actions</th>
                    <td mat-cell *matCellDef="let timetable">
                      <button mat-icon-button [matMenuTriggerFor]="menu" color="primary">
                        <mat-icon>more_vert</mat-icon>
                      </button>
                      <mat-menu #menu="matMenu">
                        <button mat-menu-item 
                                *ngIf="timetable.status === 'PROPOSED'"
                                (click)="validateTimetable(timetable)">
                          <mat-icon color="primary">check</mat-icon>
                          <span>Valider</span>
                        </button>
                        <button mat-menu-item 
                                *ngIf="timetable.status === 'PROPOSED'"
                                (click)="rejectTimetable(timetable)">
                          <mat-icon color="warn">close</mat-icon>
                          <span>Rejeter</span>
                        </button>
                        <button mat-menu-item>
                          <mat-icon>edit</mat-icon>
                          <span>Modifier</span>
                        </button>
                        <button mat-menu-item>
                          <mat-icon color="warn">delete</mat-icon>
                          <span>Supprimer</span>
                        </button>
                      </mat-menu>
                    </td>
                  </ng-container>

                  <tr mat-header-row *matHeaderRowDef="displayedColumns"></tr>
                  <tr mat-row *matRowDef="let row; columns: displayedColumns;"></tr>
                </table>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

      <!-- Gestion des Conflits -->
      <mat-tab label="Conflits" [disabled]="conflicts.length === 0">
        <div class="tab-content">
          <mat-card class="conflicts-card">
            <mat-card-header>
              <mat-icon mat-card-avatar color="warn">warning</mat-icon>
              <mat-card-title>Conflits d'Emplois du Temps</mat-card-title>
              <mat-card-subtitle>{{ conflicts.length }} conflit(s) détecté(s)</mat-card-subtitle>
            </mat-card-header>
            
            <mat-card-content>
              <div *ngIf="conflicts.length === 0" class="no-conflicts">
                <mat-icon>check_circle</mat-icon>
                <h3>Aucun conflit détecté</h3>
                <p>Tous les emplois du temps sont compatibles.</p>
              </div>
              
              <div *ngIf="conflicts.length > 0" class="conflicts-list">
                <div *ngFor="let conflict of conflicts" class="conflict-item">
                  <div class="conflict-header">
                    <mat-chip [color]="getConflictSeverityColor(conflict.severity)">
                      {{ conflict.severity }}
                    </mat-chip>
                    <span class="conflict-type">{{ conflict.type }}</span>
                  </div>
                  
                  <div class="conflict-description">
                    {{ conflict.description }}
                  </div>
                  
                  <div class="conflict-actions">
                    <button mat-button color="primary" (click)="resolveConflict(conflict)">
                      <mat-icon>build</mat-icon>
                      Résoudre
                    </button>
                  </div>
                </div>
              </div>
            </mat-card-content>
          </mat-card>
        </div>
      </mat-tab>

    </mat-tab-group>
  </div>
</div>